 行为式验证技术 极验验证 [scripts](https://www.v2ex.com/t/138479)
=======

something interesting for [geetest](http://www.geetest.com/install/sections/idx-basic-introduction.html)

sdk:  [java](https://github.com/GeeTeam/gt-java-sdk), [nodejs](https://github.com/GeeTeam/gt-node-sdk)

无意间发现豆瓣在登陆页使用了极验验证提供的验证码服务。
总觉得吧，这东西好像不安全。这个“基于行为的验证安全技术”到底是啥呢？
看了看调用的js，大概是只要鼠标发生移动就记录xy坐标和时间，最后对这个序列以及最终停下的位置分别加密，发给服务器判定。

那么问题来了。。。

#### 1.最终停止位置xpos
每次验证请求都会得到三张图，fullbg：完整的验证图形、slice：拼图那一小块、bg：拼图对应那一块加阴影的fullbg，对比fullbg和bg，哪一列像素上开始发生较大变化那就是xpos
如果以后不提供fullbg，只要得到几张不同的bg，求它们的交集即可得到fullbg，不需要机器学习算法
#### 2.鼠标移动轨迹a
根据xpos可以确定大概需要生成多少帧
x随帧编号产生不均匀增加，直至xpos，开始是用arctan函数模拟的，后来发现完全没必要，建个bitmap[xpos]，从里面随机挑选不重复项选就行了
y用长周期小振幅的sin函数模拟
t随时间产生不均匀增加，并加入一些跳变
用以上方法填充a
#### 3.加密
不需要破解，从js中剥离加密相关的函数，放入js虚拟机，传入xpos和a并执行，获得加密后结果

问题解决，大家应该知道哪家强了。。。

代码 [戳这里](https://github.com/procen424/scripts/blob/master/geetest-bypass.go) 写得仓促，码风dirty

##### 说明

    go run geetest-bypass.go -c=次数 -gt="站点的gtid" 默认尝试豆瓣的验证码100次
    success = 1 message = blahblahblah 通过
    success = 0 message = failed 未通过
    forbidden 判定为机器人

##### 截至发帖时，识别通过率99%+

大家尽情玩耍

* 第 1 条附言  ·  2014-10-12 20:59:02 +08:00

2014-10-12 20:57 通过率下降至97%，正确率依然99%+。难道已经有极验的朋友看到了本文？

* 第 2 条附言  ·  2014-10-12 21:11:47 +08:00

2014-10-12 通过率60% 正确率99%+ 极验的动作好快！js库已更新至2.8.5！赞一个！

* 第 3 条附言  ·  2014-10-12 21:12:16 +08:00

2014-10-12 21:11 通过率60% 正确率99%+ 极验的动作好快！js库已更新至2.8.5！赞一个！

* 第 4 条附言  ·  2014-10-13 08:27:20 +08:00

2014-10-13 08:27 通过率99%+ 正确率99%+ 脚本已更新。极验更新了客户端js库，改了一个随机数生成函数，服务器端开始检查user-agent。

* 第 5 条附言  ·  2014-10-13 10:08:02 +08:00

2014-10-13 10:08 通过率99%+ 正确率99%+ 极验再次更新，加入referer检测，请在脚本中自行修改。目前，核心算法仍不能识别机器行为，只要外界参数满足条件，脚本产生的xPosAnswer和moveTrack便可通过验证。极验的朋友们也不容易，大家别玩太狠了。

* 第 6 条附言  ·  2014-10-13 13:11:52 +08:00

2014-10-13 13:11 豆瓣登陆页已更换回原来的文字验证码233333333333

* 第 7 条附言  ·  2014-10-13 13:34:37 +08:00

2014-10-13 13:33 大概是因为这个帖子，害得两家公司白忙活一场，还让豆瓣在首页放上了验证码，在此道歉：“对不起，给大家添堵了！” (｡•ˇ‸ˇ•｡)
